<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIEM Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1a1d3a 0%, #2d1b69 100%);
            min-height: 100vh;
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(96, 165, 250, 0.3);
        }

        .header p {
            font-size: 1rem;
            color: #94a3b8;
        }

        .main-interface {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .query-section {
            margin-bottom: 24px;
        }

        .query-input-container {
            position: relative;
            margin-bottom: 16px;
        }

        #queryInput {
            width: 100%;
            padding: 16px 56px 16px 16px;
            font-size: 15px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            color: #f1f5f9;
            outline: none;
            transition: all 0.3s ease;
        }

        #queryInput:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(30, 41, 59, 0.9);
        }

        #queryInput::placeholder {
            color: #64748b;
        }

        .query-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .query-button:hover:not(:disabled) {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .query-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .suggestion-chip {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion-chip:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #94a3b8;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #64748b;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot.disconnected {
            background: #ef4444;
        }

        .results-section {
            display: none;
            margin-top: 24px;
        }

        .results-section.show {
            display: block;
        }

        .results-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }

        .results-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 8px;
        }

        .results-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #94a3b8;
        }

        .insight-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .insight-card {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .insight-card h3 {
            color: #60a5fa;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .insight-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .insight-label {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            color: #94a3b8;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            color: #60a5fa;
            border-bottom-color: #3b82f6;
        }

        .tab:hover:not(.active) {
            color: #cbd5e1;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .visualization-container {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .visualization-container h3 {
            color: #f1f5f9;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 16px;
        }

        .event-timeline {
            max-height: 400px;
            overflow-y: auto;
        }

        .timeline-item {
            display: flex;
            padding: 12px;
            border-left: 3px solid #3b82f6;
            margin-bottom: 12px;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            transform: translateX(4px);
            background: rgba(30, 41, 59, 0.6);
        }

        .timeline-time {
            flex-shrink: 0;
            width: 100px;
            font-weight: 600;
            color: #60a5fa;
            font-size: 0.85rem;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-event {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .timeline-details {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .severity-high {
            border-left-color: #ef4444;
        }

        .severity-medium {
            border-left-color: #f59e0b;
        }

        .severity-low {
            border-left-color: #10b981;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }

        .data-table th {
            background: rgba(59, 130, 246, 0.1);
            font-weight: 600;
            color: #60a5fa;
            font-size: 0.9rem;
        }

        .data-table td {
            color: #e2e8f0;
            font-size: 0.85rem;
        }

        .data-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #fca5a5;
            margin: 16px 0;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-interface {
                padding: 20px;
            }
            
            .insight-cards {
                grid-template-columns: 1fr;
            }
            
            .results-meta {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SIEM Assistant</h1>
            <p>Natural Language Interface for Security Investigation</p>
        </div>

        <div class="main-interface">
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot" id="connectionStatus"></div>
                    <span id="connectionText">Connecting...</span>
                </div>
                <div id="sessionInfo">Session: --</div>
            </div>

            <div class="query-section">
                <div class="query-input-container">
                    <input 
                        type="text" 
                        id="queryInput" 
                        placeholder="Ask about security events... (e.g., 'Show me failed login attempts yesterday')"
                        autocomplete="off"
                    />
                    <button class="query-button" id="queryButton" onclick="processQuery()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>

                <div class="suggestions">
                    <div class="suggestion-chip" onclick="setQuery('Show me failed login attempts yesterday')">Failed Logins</div>
                    <div class="suggestion-chip" onclick="setQuery('Analyze malware detections in the past week')">Malware Analysis</div>
                    <div class="suggestion-chip" onclick="setQuery('Network anomalies in the last 24 hours')">Network Anomalies</div>
                    <div class="suggestion-chip" onclick="setQuery('VPN connection activities today')">VPN Activities</div>
                    <div class="suggestion-chip" onclick="setQuery('Generate security summary report')">Security Report</div>
                </div>

                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>Processing your query...</p>
                </div>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <div class="results-title" id="resultsTitle">Analysis Results</div>
                    <div class="results-meta">
                        <span id="resultCount">0 events found</span>
                        <span id="processingTime">0ms</span>
                        <span id="confidence">Confidence: 0%</span>
                    </div>
                </div>

                <div class="insight-cards" id="insightCards"></div>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('visualization')">Visualizations</div>
                    <div class="tab" onclick="switchTab('timeline')">Timeline</div>
                    <div class="tab" onclick="switchTab('data')">Raw Data</div>
                </div>

                <div class="tab-content active" id="visualization">
                    <div class="visualization-container">
                        <h3>Event Distribution</h3>
                        <div class="chart-container">
                            <canvas id="eventChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="timeline">
                    <div class="visualization-container">
                        <h3>Event Timeline</h3>
                        <div class="event-timeline" id="eventTimeline"></div>
                    </div>
                </div>

                <div class="tab-content" id="data">
                    <div class="visualization-container">
                        <h3>Event Data</h3>
                        <div id="dataTable"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = window.location.hostname === 'localhost' ? 
            'http://localhost:5000' : 'https://your-backend-url.com';
        
        // Global state
        let sessionId = null;
        let socket = null;
        let currentChart = null;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            console.log('SIEM Assistant initializing...');
            connectToBackend();
            
            // Generate session ID
            sessionId = generateSessionId();
            updateSessionInfo();
        }

        function setupEventListeners() {
            // Enter key support
            document.getElementById('queryInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    processQuery();
                }
            });

            // Auto-resize on window resize
            window.addEventListener('resize', function() {
                if (currentChart) {
                    currentChart.resize();
                }
            });
        }

        function connectToBackend() {
            // Test API health
            fetch(`${API_BASE_URL}/api/health`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'healthy') {
                        updateConnectionStatus(true, 'Connected');
                        console.log('Backend connected:', data);
                    } else {
                        updateConnectionStatus(false, 'Backend unavailable');
                    }
                })
                .catch(error => {
                    console.warn('Backend connection failed, using demo mode:', error);
                    updateConnectionStatus(false, 'Demo mode');
                });

            // Initialize WebSocket if available
            try {
                socket = io(API_BASE_URL);
                
                socket.on('connect', function() {
                    console.log('WebSocket connected');
                    socket.emit('join_session', { session_id: sessionId });
                });

                socket.on('query_result', function(data) {
                    console.log('Real-time result received:', data);
                });

                socket.on('disconnect', function() {
                    console.log('WebSocket disconnected');
                });
            } catch (error) {
                console.log('WebSocket not available:', error);
            }
        }

        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function updateSessionInfo() {
            document.getElementById('sessionInfo').textContent = `Session: ${sessionId.substr(-8)}`;
        }

        function updateConnectionStatus(connected, message) {
            const statusDot = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            statusDot.classList.toggle('disconnected', !connected);
            statusText.textContent = message;
        }

        function setQuery(query) {
            document.getElementById('queryInput').value = query;
            processQuery();
        }

        async function processQuery() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) return;

            const queryButton = document.getElementById('queryButton');
            queryButton.disabled = true;
            showLoading(true);
            hideResults();

            try {
                // Try backend API first
                const response = await fetch(`${API_BASE_URL}/api/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        session_id: sessionId
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        displayResults(query, result);
                    } else {
                        throw new Error(result.error || 'Query processing failed');
                    }
                } else {
                    throw new Error(`API request failed: ${response.status}`);
                }
            } catch (error) {
                console.warn('Backend query failed, using demo mode:', error);
                // Fallback to demo mode
                await processDemoQuery(query);
            } finally {
                showLoading(false);
                queryButton.disabled = false;
            }
        }

        async function processDemoQuery(query) {
            // Simulate processing delay
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Analyze query locally for demo
            const analysis = analyzeDemoQuery(query);
            const mockResults = generateDemoResults(analysis);

            displayResults(query, {
                success: true,
                query_analysis: analysis,
                results: mockResults,
                insights: generateDemoInsights(mockResults)
            });
        }

        function analyzeDemoQuery(query) {
            const lowerQuery = query.toLowerCase();
            
            // Simple entity detection
            let entities = [];
            if (lowerQuery.includes('failed login') || lowerQuery.includes('login fail')) {
                entities.push('failed login');
            }
            if (lowerQuery.includes('malware') || lowerQuery.includes('virus')) {
                entities.push('malware detection');
            }
            if (lowerQuery.includes('network') || lowerQuery.includes('anomaly')) {
                entities.push('network anomaly');
            }
            if (lowerQuery.includes('vpn')) {
                entities.push('vpn connection');
            }

            // Intent detection
            let intent = 'search';
            if (lowerQuery.includes('analyze') || lowerQuery.includes('analysis')) {
                intent = 'analyze';
            } else if (lowerQuery.includes('report') || lowerQuery.includes('generate')) {
                intent = 'report';
            }

            return {
                original_query: query,
                entities: entities,
                intent: intent,
                confidence: entities.length > 0 ? 0.9 : 0.6,
                processing_time: 0.8
            };
        }

        function generateDemoResults(analysis) {
            const events = [];
            const entities = analysis.entities || [];

            // Generate events based on entities
            entities.forEach(entity => {
                if (entity === 'failed login') {
                    events.push(...generateAuthEvents());
                } else if (entity === 'malware detection') {
                    events.push(...generateMalwareEvents());
                } else if (entity === 'network anomaly') {
                    events.push(...generateNetworkEvents());
                } else if (entity === 'vpn connection') {
                    events.push(...generateVpnEvents());
                }
            });

            // Sort by timestamp
            events.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            return {
                total_hits: events.length,
                sample_events: events.slice(0, 10),
                query_time: 0.8,
                data_source: 'demo'
            };
        }

        function generateAuthEvents() {
            const events = [];
            const baseTime = new Date();
            
            for (let i = 0; i < 6; i++) {
                const eventTime = new Date(baseTime.getTime() - (i * 60 * 60 * 1000));
                events.push({
                    timestamp: eventTime.toISOString(),
                    'event.category': 'authentication',
                    'event.outcome': Math.random() > 0.3 ? 'failure' : 'success',
                    'user.name': `user${Math.floor(Math.random() * 10) + 1}`,
                    'source.ip': `192.168.1.${Math.floor(Math.random() * 100) + 100}`,
                    'host.name': `workstation-${Math.floor(Math.random() * 20) + 1}`,
                    severity: Math.random() > 0.5 ? 'medium' : 'high'
                });
            }
            
            return events;
        }

        function generateMalwareEvents() {
            const events = [];
            const baseTime = new Date();
            
            for (let i = 0; i < 4; i++) {
                const eventTime = new Date(baseTime.getTime() - (i * 2 * 60 * 60 * 1000));
                events.push({
                    timestamp: eventTime.toISOString(),
                    'event.category': 'malware',
                    'file.name': ['suspicious.exe', 'malware.dll', 'trojan.bin'][Math.floor(Math.random() * 3)],
                    'host.name': `endpoint-${Math.floor(Math.random() * 15) + 1}`,
                    'threat.indicator.type': ['trojan', 'virus', 'spyware'][Math.floor(Math.random() * 3)],
                    severity: Math.random() > 0.3 ? 'high' : 'critical'
                });
            }
            
            return events;
        }

        function generateNetworkEvents() {
            const events = [];
            const baseTime = new Date();
            
            for (let i = 0; i < 5; i++) {
                const eventTime = new Date(baseTime.getTime() - (i * 30 * 60 * 1000));
                events.push({
                    timestamp: eventTime.toISOString(),
                    'event.category': 'network',
                    'source.ip': `203.0.113.${Math.floor(Math.random() * 254) + 1}`,
                    'destination.port': [80, 443, 22, 3389][Math.floor(Math.random() * 4)],
                    'event.action': ['blocked', 'allowed', 'monitored'][Math.floor(Math.random() * 3)],
                    severity: ['low', 'medium', 'high'][Math.floor(Math.random() * 3)]
                });
            }
            
            return events;
        }

        function generateVpnEvents() {
            const events = [];
            const baseTime = new Date();
            
            for (let i = 0; i < 3; i++) {
                const eventTime = new Date(baseTime.getTime() - (i * 60 * 60 * 1000));
                events.push({
                    timestamp: eventTime.toISOString(),
                    'event.category': 'authentication',
                    'service.name': 'vpn',
                    'user.name': `remote_user${Math.floor(Math.random() * 5) + 1}`,
                    'source.ip': `203.0.113.${Math.floor(Math.random() * 254) + 1}`,
                    'event.outcome': Math.random() > 0.2 ? 'success' : 'failure',
                    severity: 'low'
                });
            }
            
            return events;
        }

        function generateDemoInsights(results) {
            const insights = [];
            const events = results.sample_events || [];
            
            if (events.length > 0) {
                insights.push(`Analyzed ${events.length} security events`);
                
                const highSeverity = events.filter(e => e.severity === 'high' || e.severity === 'critical').length;
                if (highSeverity > 0) {
                    insights.push(`${highSeverity} high/critical severity events detected`);
                }
                
                const uniqueIPs = new Set(events.map(e => e['source.ip']).filter(Boolean)).size;
                if (uniqueIPs > 0) {
                    insights.push(`${uniqueIPs} unique source IPs involved`);
                }
            }
            
            return insights;
        }

        function displayResults(query, result) {
            const queryAnalysis = result.query_analysis || {};
            const results = result.results || {};
            const insights = result.insights || [];

            // Update results header
            document.getElementById('resultsTitle').textContent = `Results for: "${query}"`;
            document.getElementById('resultCount').textContent = `${results.total_hits || 0} events found`;
            document.getElementById('processingTime').textContent = `${Math.round((queryAnalysis.processing_time || 0) * 1000)}ms`;
            document.getElementById('confidence').textContent = `Confidence: ${Math.round((queryAnalysis.confidence || 0) * 100)}%`;

            // Display insight cards
            displayInsightCards(results, insights);

            // Display visualizations
            displayChart(results.sample_events || []);

            // Display timeline
            displayTimeline(results.sample_events || []);

            // Display data table
            displayDataTable(results.sample_events || []);

            // Show results
            showResults();
        }

        function displayInsightCards(results, insights) {
            const container = document.getElementById('insightCards');
            container.innerHTML = '';

            const events = results.sample_events || [];
            const totalEvents = results.total_hits || events.length;
            const highSeverity = events.filter(e => e.severity === 'high' || e.severity === 'critical').length;
            const uniqueIPs = new Set(events.map(e => e['source.ip']).filter(Boolean)).size;
            const uniqueHosts = new Set(events.map(e => e['host.name']).filter(Boolean)).size;

            const cards = [
                { title: 'Total Events', value: totalEvents, label: 'security events' },
                { title: 'High Severity', value: highSeverity, label: 'critical incidents' },
                { title: 'Source IPs', value: uniqueIPs, label: 'unique addresses' },
                { title: 'Affected Hosts', value: uniqueHosts, label: 'systems involved' }
            ];

            cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'insight-card';
                cardElement.innerHTML = `
                    <h3>${card.title}</h3>
                    <div class="insight-value">${card.value}</div>
                    <div class="insight-label">${card.label}</div>
                `;
                container.appendChild(cardElement);
            });
        }

        function displayChart(events) {
            const canvas = document.getElementById('eventChart');
            const ctx = canvas.getContext('2d');

            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
            }

            // Prepare data
            const categories = {};
            events.forEach(event => {
                const category = event['event.category'] || 'unknown';
                categories[category] = (categories[category] || 0) + 1;
            });

            const labels = Object.keys(categories);
            const data = Object.values(categories);
            const colors = ['#3b82f6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];

            currentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(label => label.charAt(0).toUpperCase() + label.slice(1)),
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#1e293b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e2e8f0',
                                font: { size: 12 },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: '#3b82f6',
                            borderWidth: 1
                        }
                    }
                }
            });
        }

        function displayTimeline(events) {
            const container = document.getElementById('eventTimeline');
            container.innerHTML = '';

            if (events.length === 0) {
                container.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No events to display</p>';
                return;
            }

            events.slice(0, 15).forEach(event => {
                const timelineItem = document.createElement('div');
                const severityClass = event.severity ? `severity-${event.severity}` : '';
                timelineItem.className = `timeline-item ${severityClass}`;
                
                const eventTime = new Date(event.timestamp);
                const timeString = eventTime.toLocaleTimeString();
                const category = event['event.category'] || 'security';
                const outcome = event['event.outcome'] || event['event.action'] || 'detected';
                const source = event['source.ip'] || event['host.name'] || 'system';
                
                timelineItem.innerHTML = `
                    <div class="timeline-time">${timeString}</div>
                    <div class="timeline-content">
                        <div class="timeline-event">${category.charAt(0).toUpperCase() + category.slice(1)} Event</div>
                        <div class="timeline-details">
                            ${outcome} | Source: ${source} | Severity: ${(event.severity || 'medium').toUpperCase()}
                        </div>
                    </div>
                `;
                
                container.appendChild(timelineItem);
            });
        }

        function displayDataTable(events) {
            const container = document.getElementById('dataTable');
            
            if (events.length === 0) {
                container.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 20px;">No data available</p>';
                return;
            }

            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Category</th>
                            <th>Source</th>
                            <th>Severity</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            events.slice(0, 20).forEach(event => {
                const eventTime = new Date(event.timestamp).toLocaleString();
                const category = event['event.category'] || 'security';
                const source = event['source.ip'] || event['host.name'] || '--';
                const severity = event.severity || 'medium';
                const details = event['user.name'] || event['file.name'] || event['event.action'] || 'Security event';
                
                tableHTML += `
                    <tr>
                        <td>${eventTime}</td>
                        <td>${category}</td>
                        <td>${source}</td>
                        <td><span style="color: ${getSeverityColor(severity)}">${severity.toUpperCase()}</span></td>
                        <td>${details}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        function getSeverityColor(severity) {
            const colors = {
                'low': '#10b981',
                'medium': '#f59e0b', 
                'high': '#ef4444',
                'critical': '#dc2626'
            };
            return colors[severity.toLowerCase()] || '#94a3b8';
        }

        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showLoading(show) {
            const loader = document.getElementById('loadingIndicator');
            if (show) {
                loader.classList.add('show');
            } else {
                loader.classList.remove('show');
            }
        }

        function showResults() {
            document.getElementById('resultsSection').classList.add('show');
        }

        function hideResults() {
            document.getElementById('resultsSection').classList.remove('show');
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const container = document.querySelector('.main-interface');
            container.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === '/') {
                e.preventDefault();
                document.getElementById('queryInput').focus();
            }
        });

        // Health check and keep-alive
        setInterval(async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                if (response.ok) {
                    const data = await response.json();
                    updateConnectionStatus(data.status === 'healthy', 
                        data.status === 'healthy' ? 'Connected' : 'Backend issues');
                } else {
                    updateConnectionStatus(false, 'Connection lost');
                }
            } catch (error) {
                updateConnectionStatus(false, 'Demo mode');
            }
        }, 30000); // Check every 30 seconds

        // Auto-save query history to localStorage
        function saveQueryToHistory(query, success) {
            try {
                const history = JSON.parse(localStorage.getItem('siemQueryHistory') || '[]');
                history.unshift({
                    query: query,
                    timestamp: new Date().toISOString(),
                    success: success,
                    sessionId: sessionId
                });
                
                // Keep only last 50 queries
                if (history.length > 50) {
                    history.splice(50);
                }
                
                localStorage.setItem('siemQueryHistory', JSON.stringify(history));
            } catch (error) {
                console.log('Could not save query history:', error);
            }
        }

        // Update processQuery to save history
        const originalProcessQuery = processQuery;
        processQuery = async function() {
            const query = document.getElementById('queryInput').value.trim();
            let success = false;
            
            try {
                await originalProcessQuery();
                success = true;
            } catch (error) {
                success = false;
                throw error;
            } finally {
                saveQueryToHistory(query, success);
            }
        };

        console.log('SIEM Assistant loaded successfully');
        console.log('Features: NLP Processing, Real-time Updates, Dark Theme');
        console.log('Backend:', API_BASE_URL);

    </script>
</body>
</html>